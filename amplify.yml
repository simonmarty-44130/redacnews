version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --legacy-peer-deps
        - npx prisma generate --schema=packages/db/prisma/schema.prisma
    build:
      commands:
        - export NODE_OPTIONS="--max-old-space-size=8192"
        # Create .env.production with runtime env vars for Next.js SSR
        - |
          cat > apps/web/.env.production << EOF
          DATABASE_URL=${DATABASE_URL}
          GOOGLE_SERVICE_ACCOUNT_KEY=${GOOGLE_SERVICE_ACCOUNT_KEY}
          GOOGLE_DRIVE_FOLDER_ID=${GOOGLE_DRIVE_FOLDER_ID}
          GOOGLE_IMPERSONATE_EMAIL=${GOOGLE_IMPERSONATE_EMAIL}
          MY_AWS_ACCESS_KEY_ID=${MY_AWS_ACCESS_KEY_ID}
          MY_AWS_SECRET_ACCESS_KEY=${MY_AWS_SECRET_ACCESS_KEY}
          MY_AWS_REGION=${MY_AWS_REGION}
          S3_BUCKET=${S3_BUCKET}
          S3_BUCKET_REGION=${S3_BUCKET_REGION}
          CLOUDFRONT_DOMAIN=${CLOUDFRONT_DOMAIN}
          SES_FROM_EMAIL=${SES_FROM_EMAIL}
          NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
          NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID}
          NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
          EOF
        - cd apps/web && npm run build
        # Copy .env.production to standalone for runtime
        - cp apps/web/.env.production apps/web/.next/standalone/apps/web/.env.production
  artifacts:
    baseDirectory: apps/web/.next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - apps/web/.next/cache/**/*
