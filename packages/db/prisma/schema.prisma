generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  slug             String            @unique
  logo             String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  collections      Collection[]
  constituencies   Constituency[]
  mediaItems       MediaItem[]
  montageProjects  MontageProject[]
  politicalTags    PoliticalTag[]
  rundownTemplates RundownTemplate[]
  shows            Show[]
  stories          Story[]
  users            User[]
}

model Constituency {
  id             String       @id @default(cuid())
  name           String
  department     String?
  isActive       Boolean      @default(true)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@index([organizationId])
}

model User {
  id              String              @id @default(cuid())
  cognitoId       String              @unique
  email           String              @unique
  firstName       String?
  lastName        String?
  avatarUrl       String?
  role            UserRole            @default(JOURNALIST)
  organizationId  String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  comments        Comment[]
  mediaItems      MediaItem[]
  montageProjects MontageProject[]
  sentGuestShares RundownGuestShare[] @relation("GuestShareSentBy")
  rundownItems    RundownItem[]
  assignedStories Story[]             @relation("StoryAssignee")
  stories         Story[]             @relation("StoryAuthor")
  organization    Organization        @relation(fields: [organizationId], references: [id])
}

model Show {
  id              String            @id @default(cuid())
  name            String
  description     String?
  defaultDuration Int               @default(60)
  color           String            @default("#3B82F6")
  organizationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  category        ShowCategory      @default(MAGAZINE)
  startTime       String            @default("12:00")
  rundowns        Rundown[]
  templates       RundownTemplate[]
  organization    Organization      @relation(fields: [organizationId], references: [id])
}

model Rundown {
  id                String              @id @default(cuid())
  showId            String
  date              DateTime
  status            RundownStatus       @default(DRAFT)
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  scriptDocId       String?
  scriptDocUrl      String?
  scriptGeneratedAt DateTime?
  currentItemId     String?
  endTime           String?
  location          String?
  locationAddress   String?
  startTime         String?
  subtitle          String?
  title             String?
  templateVariables Json?               // Variables du template utilisées à la création (noms des invités, etc.)
  show              Show                @relation(fields: [showId], references: [id])
  guestShares       RundownGuestShare[]
  linkedFromItems   RundownItem[]       @relation("LinkedRundown")
  items             RundownItem[]
  team              RundownTeamMember[]
}

model RundownTeamMember {
  id        String   @id @default(cuid())
  rundownId String
  role      TeamRole
  name      String
  phone     String?
  email     String?
  location  String?
  notes     String?
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  rundown   Rundown  @relation(fields: [rundownId], references: [id], onDelete: Cascade)

  @@index([rundownId])
}

model RundownItem {
  id              String             @id @default(cuid())
  rundownId       String
  storyId         String?
  type            RundownItemType
  title           String
  duration        Int
  position        Int
  notes           String?
  status          ItemStatus         @default(PENDING)
  assigneeId      String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  script          String?
  googleDocId     String?
  googleDocUrl    String?
  linkedRundownId String?
  assignee        User?              @relation(fields: [assigneeId], references: [id])
  linkedRundown   Rundown?           @relation("LinkedRundown", fields: [linkedRundownId], references: [id])
  rundown         Rundown            @relation(fields: [rundownId], references: [id], onDelete: Cascade)
  story           Story?             @relation(fields: [storyId], references: [id])
  guests          RundownItemGuest[]
  media           RundownItemMedia[]
}

model RundownItemMedia {
  id            String      @id @default(cuid())
  rundownItemId String
  mediaItemId   String
  position      Int
  mediaItem     MediaItem   @relation(fields: [mediaItemId], references: [id])
  rundownItem   RundownItem @relation(fields: [rundownItemId], references: [id], onDelete: Cascade)
}

model Story {
  id                String              @id @default(cuid())
  title             String
  slug              String
  googleDocId       String?
  googleDocUrl      String?
  content           String?
  summary           String?
  status            StoryStatus         @default(DRAFT)
  category          String?
  tags              String[]
  estimatedDuration Int?
  authorId          String
  assigneeId        String?
  organizationId    String
  publishedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  electionType      ElectionType?
  comments          Comment[]
  rundownItems      RundownItem[]
  assignee          User?               @relation("StoryAssignee", fields: [assigneeId], references: [id])
  author            User                @relation("StoryAuthor", fields: [authorId], references: [id])
  organization      Organization        @relation(fields: [organizationId], references: [id])
  media             StoryMedia[]
  politicalTags     StoryPoliticalTag[]
}

model StoryMedia {
  id            String             @id @default(cuid())
  storyId       String
  mediaItemId   String
  position      Int
  notes         String?
  createdAt     DateTime           @default(now())
  cuePoint      String?
  insertionType MediaInsertionType @default(REFERENCE)
  textMarker    String?
  timecodeEnd   Int?
  timecodeStart Int?
  updatedAt     DateTime           @updatedAt
  mediaItem     MediaItem          @relation(fields: [mediaItemId], references: [id])
  story         Story              @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, mediaItemId])
  @@index([storyId])
  @@index([mediaItemId])
}

model MediaItem {
  id                  String              @id @default(cuid())
  title               String
  description         String?
  type                MediaType
  mimeType            String
  fileSize            Int
  duration            Int?
  s3Key               String
  s3Url               String
  thumbnailUrl        String?
  waveformData        Json?
  transcription       String?
  transcriptionStatus TranscriptionStatus @default(NONE)
  tags                String[]
  uploadedById        String
  organizationId      String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  usageCount          Int                 @default(0)
  collections         CollectionItem[]
  organization        Organization        @relation(fields: [organizationId], references: [id])
  uploadedBy          User                @relation(fields: [uploadedById], references: [id])
  montageClips        MontageClip[]
  rundownItemMedia    RundownItemMedia[]
  storyMedia          StoryMedia[]
}

model Collection {
  id             String           @id @default(cuid())
  name           String
  description    String?
  color          String           @default("#6366F1")
  isPublic       Boolean          @default(true)
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id])
  items          CollectionItem[]
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  mediaItemId  String
  position     Int
  addedAt      DateTime   @default(now())
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  mediaItem    MediaItem  @relation(fields: [mediaItemId], references: [id])

  @@unique([collectionId, mediaItemId])
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  storyId   String
  authorId  String
  parentId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  author    User      @relation(fields: [authorId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
}

model MontageProject {
  id             String         @id @default(cuid())
  name           String
  description    String?
  duration       Float          @default(0)
  organizationId String
  createdById    String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      User           @relation(fields: [createdById], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id])
  tracks         MontageTrack[]

  @@index([organizationId])
  @@index([createdById])
}

model MontageTrack {
  id        String         @id @default(cuid())
  projectId String
  name      String
  color     String         @default("#3B82F6")
  order     Int
  volume    Float          @default(1)
  pan       Float          @default(0)
  muted     Boolean        @default(false)
  solo      Boolean        @default(false)
  clips     MontageClip[]
  project   MontageProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model MontageClip {
  id              String       @id @default(cuid())
  trackId         String
  name            String
  mediaItemId     String?
  sourceUrl       String
  sourceDuration  Float
  startTime       Float
  inPoint         Float
  outPoint        Float
  volume          Float        @default(1)
  fadeInDuration  Float        @default(0)
  fadeOutDuration Float        @default(0)
  mediaItem       MediaItem?   @relation(fields: [mediaItemId], references: [id])
  track           MontageTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@index([mediaItemId])
}

model RundownTemplate {
  id             String                @id @default(cuid())
  name           String
  description    String?
  showId         String
  isDefault      Boolean               @default(false)
  variables      Json?
  organizationId String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id])
  show           Show                  @relation(fields: [showId], references: [id])
  items          RundownTemplateItem[]

  @@index([showId])
  @@index([organizationId])
}

model RundownTemplateItem {
  id         String          @id @default(cuid())
  templateId String
  type       RundownItemType
  title      String
  duration   Int
  position   Int
  notes      String?
  script     String?
  template   RundownTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model RundownItemGuest {
  id            String      @id @default(cuid())
  rundownItemId String
  name          String
  email         String?
  role          String?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  description   String?
  organization  String?
  phone         String?
  position      Int         @default(0)
  title         String?
  rundownItem   RundownItem @relation(fields: [rundownItemId], references: [id], onDelete: Cascade)

  @@index([rundownItemId])
  @@index([email])
}

model RundownGuestShare {
  id               String    @id @default(cuid())
  rundownId        String
  recipientEmail   String
  recipientName    String?
  highlightedItems String[]
  personalMessage  String?
  includedPdf      Boolean   @default(false)
  sentAt           DateTime  @default(now())
  sentById         String
  accessToken      String?   @unique
  tokenExpiresAt   DateTime?
  viewedAt         DateTime?
  rundown          Rundown   @relation(fields: [rundownId], references: [id], onDelete: Cascade)
  sentBy           User      @relation("GuestShareSentBy", fields: [sentById], references: [id])

  @@index([rundownId])
  @@index([recipientEmail])
  @@index([accessToken])
}

model PoliticalTag {
  id             String              @id @default(cuid())
  family         PoliticalFamily
  partyName      String?
  candidateName  String?
  electionType   ElectionType?
  electionYear   Int?
  constituency   String?
  organizationId String
  createdAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id])
  stories        StoryPoliticalTag[]

  @@index([organizationId])
  @@index([family])
  @@index([electionType, electionYear])
}

model StoryPoliticalTag {
  id             String       @id @default(cuid())
  storyId        String
  politicalTagId String
  speakingTime   Int?
  isMainSubject  Boolean      @default(false)
  createdAt      DateTime     @default(now())
  politicalTag   PoliticalTag @relation(fields: [politicalTagId], references: [id])
  story          Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, politicalTagId])
  @@index([storyId])
  @@index([politicalTagId])
}

enum UserRole {
  ADMIN
  EDITOR_IN_CHIEF
  JOURNALIST
  TECHNICIAN
  FREELANCER
}

enum ShowCategory {
  FLASH
  JOURNAL
  MAGAZINE
  CHRONIQUE
  AUTRE
}

enum TeamRole {
  PRESENTER
  CO_PRESENTER
  STUDIO_HOST
  TECHNICIAN
  JOURNALIST
  MAIN_GUEST
  OTHER
}

enum RundownStatus {
  DRAFT
  READY
  ON_AIR
  ARCHIVED
}

enum RundownItemType {
  STORY
  INTERVIEW
  JINGLE
  MUSIC
  LIVE
  BREAK
  OTHER
}

enum ItemStatus {
  PENDING
  IN_PROGRESS
  READY
  ON_AIR
  DONE
}

enum StoryStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum MediaInsertionType {
  INLINE
  BACKGROUND
  REFERENCE
}

enum MediaType {
  AUDIO
  VIDEO
  IMAGE
  DOCUMENT
}

enum TranscriptionStatus {
  NONE
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ElectionType {
  MUNICIPALES
  LEGISLATIVES
  PRESIDENTIELLE
  EUROPEENNES
  REGIONALES
  DEPARTEMENTALES
  SENATORIALES
  OTHER
}

enum PoliticalFamily {
  EXG
  GAU
  ECO
  CEN
  DRO
  EXD
  DIV
  AUT
}
